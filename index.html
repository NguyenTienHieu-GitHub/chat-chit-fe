<!doctype html>
<html lang="vi">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
    <title>Ch√°t Ch√≠t</title>
    <style>
        :root {
            --bg: #0b0b0b;
            --panel: #121212;
            --text: #e5e7eb;
            --muted: #9ca3af;
            --border: #1f1f1f;
            --me: #000;
            --you: #1a1a1a;
            --shadow: 0 1px 2px rgba(0, 0, 0, .5);
            --kb: 0px;
            --composer-h: 60px
        }

        * {
            box-sizing: border-box
        }

        html,
        body {
            height: 100%
        }

        body {
            margin: 0;
            background: var(--bg);
            color: var(--text);
            font: 16px/1.4 system-ui, -apple-system, Segoe UI, Roboto
        }

        .app {
            display: flex;
            flex-direction: column;
            height: 100dvh;
            padding: 12px;
            gap: 12px;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom)
        }

        .card {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px;
            position: relative;
            z-index: 2
        }

        .row {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center
        }

        input,
        button {
            padding: 10px 12px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: #0f0f0f;
            color: var(--text)
        }

        input {
            flex: 1
        }

        button {
            background: #000;
            font-weight: 700
        }

        .muted {
            color: var(--muted);
            font-size: 12px
        }

        .top {
            display: flex;
            justify-content: space-between;
            gap: 8px
        }

        .badge {
            font-size: 12px;
            color: var(--muted)
        }

        .thread {
            flex: 1;
            overflow: auto;
            padding: 12px;
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            position: relative;
            z-index: 1;
            padding-bottom: calc(var(--composer-h) + 16px)
        }

        .msg {
            display: flex;
            gap: 8px;
            align-items: flex-start
        }

        .msg.me {
            justify-content: flex-end
        }

        .msg.you {
            justify-content: flex-start
        }

        .bubble {
            max-width: min(80%, 560px);
            padding: 10px 12px;
            border-radius: 16px;
            box-shadow: var(--shadow)
        }

        .me .bubble {
            background: var(--me)
        }

        .you .bubble {
            background: var(--you)
        }

        .name {
            font-weight: 700;
            margin-bottom: 4px;
            color: #e5e7eb
        }

        .meta {
            margin-top: 6px;
            color: var(--muted);
            font-size: 12px
        }

        .inputbar {
            position: fixed;
            left: 12px;
            right: 12px;
            bottom: calc(env(safe-area-inset-bottom) + var(--kb) + 12px);
            display: flex;
            gap: 8px;
            z-index: 3
        }
    </style>
</head>

<body>
    <div class="app">
        <!-- Header -->
        <div class="card">
            <div class="top">
                <div>My ID: <span id="myId" class="badge">‚Äî</span></div>
                <div>Room: <span id="curRoom" class="badge">‚Äî</span></div>
            </div>
        </div>

        <!-- Step 1: ƒëƒÉng k√Ω ID -->
        <div class="card" id="stepMe">
            <div class="row"><input id="inpMe" placeholder="Nh·∫≠p ID c·ªßa b·∫°n (vd: u123)" /></div>
            <div class="row">
                <button id="btnMe" type="button">ƒêƒÉng k√Ω ID</button>
                <span id="state1" class="muted"></span>
            </div>
        </div>

        <!-- Group panel (DUY NH·∫§T, c√≥ m·∫≠t kh·∫©u) -->
        <div class="card" id="groupPanel" style="display:none">
            <div class="row"><input id="roomId" placeholder="Room ID (vd: group-001)" /></div>
            <div class="row"><input id="roomPass" placeholder="M·∫≠t kh·∫©u ph√≤ng (ƒë·ªÉ tr·ªëng n·∫øu kh√¥ng)"
                    autocomplete="new-password" /></div>
            <div class="row">
                <button id="btnCreate" type="button">T·∫°o ph√≤ng</button>
                <button id="btnJoin" type="button">V√†o ph√≤ng</button>
            </div>
            <div class="row">
                <input id="invitePeer" placeholder="M·ªùi ID (vd: u456)" />
                <button id="btnInvite" type="button">M·ªùi</button>
                <button id="btnLeave" type="button" style="margin-left:auto">R·ªùi ph√≤ng</button>
            </div>
            <span id="gState" class="muted"></span>

        </div>

        <!-- Thread -->
        <div class="thread" id="thread" aria-live="polite"></div>

        <!-- Composer -->
        <form class="inputbar card" id="composer" style="display:none;height:var(--composer-h);align-items:center">
            <input id="inpText" placeholder="Nh·∫Øn tin..." autocomplete="off" />
            <button id="btnSend" type="submit">G·ª≠i</button>
        </form>
    </div>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const SOCKET_URL =
                location.protocol === "https:" ? "https://chat-chit.onrender.com"
                    : "http://localhost:3000"; // dev
            let socket = null;
            let my = "", currentRoom = "";

            const $ = (id) => document.getElementById(id);
            const thread = $("thread");
            const msgInput = $("inpText");

            const fmtTime = (ts) => new Date(ts).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const esc = (s) => String(s).replace(/[&<>"']/g, m => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;" }[m]));
            function render({ side, name, text, at }) {
                const row = document.createElement("div");
                row.className = `msg ${side}`;
                row.innerHTML = `<div class="bubble"><div class="name">${esc(name)}</div><div>${esc(text)}</div><div class="meta">${fmtTime(at)}</div></div>`;
                thread.appendChild(row);
                thread.scrollTop = thread.scrollHeight;
            }

            // Mobile keyboard push-up
            const root = document.documentElement;
            function updateKbInset() {
                const vv = window.visualViewport;
                if (!vv) { root.style.setProperty('--kb', '0px'); return; }
                const kb = Math.max(0, (window.innerHeight - vv.height - vv.offsetTop));
                root.style.setProperty('--kb', kb + 'px');
            }
            updateKbInset();
            if (window.visualViewport) {
                visualViewport.addEventListener('resize', updateKbInset);
                visualViewport.addEventListener('scroll', updateKbInset);
            }

            // Step 1: ƒëƒÉng k√Ω ID
            $("btnMe").addEventListener("click", () => {
                const id = $("inpMe").value.trim();
                if (!id) { $("state1").textContent = "Nh·∫≠p ID c·ªßa b·∫°n."; return; }
                my = id;

                if (socket && socket.connected) socket.disconnect();
                socket = io(SOCKET_URL, {
                    transports: ["websocket", "polling"],
                    withCredentials: true,
                    auth: { id: my },
                    timeout: 10000,
                    reconnection: true,
                    reconnectionAttempts: 10,
                    reconnectionDelay: 1000,
                    reconnectionDelayMax: 8000,
                });

                // K·∫øt n·ªëi th√†nh c√¥ng l·∫ßn ƒë·∫ßu
                socket.on("connect", () => {
                    $("state1").textContent = "ƒê√£ k·∫øt n·ªëi Socket.IO";
                });

                // Nh·∫≠n ID ƒë√£ ƒëƒÉng k√Ω
                socket.on("user:registered", (info) => {
                    $("myId").textContent = info.id;
                    $("stepMe").style.display = "none";
                    $("groupPanel").style.display = "";
                });

                // L·ªói ngay l√∫c b·∫Øt tay
                socket.on("connect_error", (e) => {
                    $("state1").textContent = e?.message || "K·∫øt n·ªëi l·ªói";
                });

                // M·∫•t k·∫øt n·ªëi
                socket.on("disconnect", (reason) => {
                    $("gState").textContent = `M·∫•t k·∫øt n·ªëi: ${reason}`;
                    $("composer").style.display = "none";
                });

                // Th·ª≠ n·ªëi l·∫°i
                socket.on("reconnect_attempt", (n) => {
                    $("gState").textContent = `ƒêang th·ª≠ k·∫øt n·ªëi l·∫°i‚Ä¶ (l·∫ßn ${n})`;
                });

                // N·ªëi l·∫°i th√†nh c√¥ng
                socket.on("reconnect", (n) => {
                    $("gState").textContent = `ƒê√£ k·∫øt n·ªëi l·∫°i (sau ${n} l·∫ßn th·ª≠).`;
                    // (tu·ª≥ ch·ªçn) auto-join ph√≤ng tr∆∞·ªõc ƒë√≥ n·∫øu b·∫°n c√≥ l∆∞u lastRoom/lastPass
                });

                // H·∫øt s·ªë l·∫ßn th·ª≠ m√† v·∫´n kh√¥ng n·ªëi ƒë∆∞·ª£c
                socket.on("reconnect_failed", () => {
                    $("gState").textContent = "Kh√¥ng th·ªÉ k·∫øt n·ªëi l·∫°i. Ki·ªÉm tra m·∫°ng v√† ƒëƒÉng k√Ω l·∫°i ID.";
                });

                // B√°o l·ªói ID tr√πng
                socket.on("user:error", (e) => {
                    $("state1").textContent = e?.error || "ID b·ªã tr√πng";
                });

                // T·∫°o/hi·ªÉn th·ªã banner m·ªùi v√†o ph√≤ng, c√≥ n√∫t Accept/Reject
                socket.on("room:incoming", ({ inviteId, roomId, fromId, at }) => {
                    // n·∫øu ƒë√£ c√≥ banner c≈© th√¨ g·ª°
                    const old = document.getElementById("inviteBar");
                    if (old) old.remove();

                    const bar = document.createElement("div");
                    bar.id = "inviteBar";
                    bar.style.position = "fixed";
                    bar.style.left = "12px";
                    bar.style.right = "12px";
                    bar.style.bottom = "calc(env(safe-area-inset-bottom) + var(--kb) + var(--composer-h) + 16px)";
                    bar.style.zIndex = "5";
                    bar.style.background = "#121212";
                    bar.style.border = "1px solid #1f1f1f";
                    bar.style.borderRadius = "12px";
                    bar.style.padding = "12px";
                    bar.style.display = "flex";
                    bar.style.gap = "8px";
                    bar.style.alignItems = "center";
                    bar.style.boxShadow = "0 8px 24px rgba(0,0,0,.6)";

                    const text = document.createElement("div");
                    text.style.flex = "1";
                    text.innerHTML = `<b>${fromId}</b> m·ªùi b·∫°n v√†o ph√≤ng <b>${roomId}</b>`;

                    const btnAccept = document.createElement("button");
                    btnAccept.textContent = "Ch·∫•p nh·∫≠n";
                    btnAccept.style.fontWeight = "700";

                    const btnReject = document.createElement("button");
                    btnReject.textContent = "T·ª´ ch·ªëi";

                    // H√†nh vi n√∫t
                    btnAccept.onclick = () => {
                        btnAccept.disabled = true; btnReject.disabled = true;
                        socket.emit("room:accept", { inviteId }, (ack) => {
                            if (!ack?.ok) {
                                // hi·ªÉn th·ªã l·ªói nh·∫π
                                document.getElementById("gState").textContent = ack?.error || "Kh√¥ng tham gia ƒë∆∞·ª£c";
                                btnAccept.disabled = false; btnReject.disabled = false;
                                return;
                            }
                            // join ok -> c·∫≠p nh·∫≠t UI nh∆∞ c≈©
                            currentRoom = ack.roomId;          // ‚úÖ d√πng ƒë√∫ng bi·∫øn ƒë√£ khai b√°o b·∫±ng let
                            $("curRoom").textContent = currentRoom;
                            $("gState").textContent = `ƒê√£ v√†o: ${currentRoom} | Members: ${ack.members.join(", ")}${ack.locked ? " | üîí" : ""}`;
                            $("composer").style.display = "";
                            thread.innerHTML = "";
                            render({ side: "you", name: "BOT ü§ñ", text: "B·∫°n ƒë√£ tham gia ph√≤ng", at: Date.now() });

                            bar.remove();
                        });
                    };

                    btnReject.onclick = () => {
                        btnAccept.disabled = true; btnReject.disabled = true;
                        socket.emit("room:reject", { inviteId }, () => {
                            document.getElementById("gState").textContent = "B·∫°n ƒë√£ t·ª´ ch·ªëi l·ªùi m·ªùi.";
                            bar.remove();
                        });
                    };

                    bar.appendChild(text);
                    bar.appendChild(btnAccept);
                    bar.appendChild(btnReject);
                    document.body.appendChild(bar);
                });

                $("btnLeave").addEventListener("click", () => {
                    if (!currentRoom) { $("gState").textContent = "B·∫°n ch∆∞a ·ªü ph√≤ng n√†o"; return; }
                    const rid = currentRoom;
                    socket.emit("room:leave", { roomId: rid }, (ack) => {
                        if (!ack?.ok) { $("gState").textContent = ack?.error || "Leave l·ªói"; return; }
                        render({ side: "you", name: "BOT ü§ñ", text: `B·∫°n ƒë√£ r·ªùi ph√≤ng`, at: Date.now() });
                        $("gState").textContent = `ƒê√£ r·ªùi: ${rid}`;
                        $("curRoom").textContent = "‚Äî";
                        $("composer").style.display = "none";
                        currentRoom = "";
                    });
                });

                // Room events
                socket.on("room:system", ({ roomId, text, at }) => {
                    if (roomId !== currentRoom) return; render({ side: "you", name: "BOT ü§ñ", text, at });
                });
                socket.on("room:rejected", ({ by }) => {
                    $("gState").textContent = `L·ªùi m·ªùi b·ªã t·ª´ ch·ªëi b·ªüi ${by}`;
                });
                socket.on("room:message", (msg) => {
                    if (msg.roomId !== currentRoom) return;
                    const side = (msg.from === my) ? "me" : "you";
                    render({ side, name: msg.from, text: msg.text, at: msg.at });
                });

            });
            document.addEventListener("visibilitychange", () => {
                if (document.visibilityState === "visible" && socket?.disconnected) {
                    $("gState").textContent = "Tab v·ª´a quay l·∫°i ‚Äî ƒëang th·ª≠ k·∫øt n·ªëi‚Ä¶";
                    socket.connect();
                }
            });

            // Create room (c√≥ th·ªÉ c√≥ m·∫≠t kh·∫©u) ‚Äî KH√îNG auto-join n·∫øu ƒë√£ t·ªìn t·∫°i
            $("btnCreate").addEventListener("click", () => {
                const rid = $("roomId").value.trim();
                const pwd = $("roomPass").value; // c√≥ th·ªÉ r·ªóng
                if (!rid) { $("gState").textContent = "Nh·∫≠p Room ID"; return; }

                socket.emit("room:create", { roomId: rid, password: pwd }, (ack) => {
                    if (!ack?.ok) {
                        if (ack?.error === "ROOM_EXISTS") {
                            // ‚úÖ Ch·ªâ th√¥ng b√°o, KH√îNG t·ª± join
                            $("gState").textContent = "‚ùó Ph√≤ng ƒë√£ t·ªìn t·∫°i. H√£y d√πng n√∫t 'V√†o ph√≤ng' ƒë·ªÉ v√†o ph√≤ng.";
                        } else {
                            $("gState").textContent = ack?.error || "T·∫°o ph√≤ng l·ªói";
                        }
                        return;
                    }

                    // T·∫°o m·ªõi OK
                    currentRoom = ack.roomId;
                    $("curRoom").textContent = currentRoom;
                    $("gState").textContent =
                        `ƒê√£ t·∫°o & v√†o: ${currentRoom} | Members: ${ack.members.join(", ")}${ack.locked ? " | üîí" : ""}`;
                    $("composer").style.display = "";
                    thread.innerHTML = "";
                    render({ side: "you", name: "BOT ü§ñ", text: `B·∫°n ƒë√£ t·∫°o ph√≤ng${ack.locked ? " (üîí)" : ""}`, at: Date.now() });
                });
            });
            // Khi r·ªùi √¥ Room ID, b√°o "ph√≤ng ƒë√£ t·ªìn t·∫°i" hay "ch∆∞a t·ªìn t·∫°i"
            $("roomId").addEventListener("blur", () => {
                const rid = $("roomId").value.trim();
                if (!rid || !socket?.connected) return;
                socket.emit("room:exists", { roomId: rid }, (ack) => {
                    if (!ack?.ok) return;
                    $("gState").textContent = ack.exists
                        ? `Ph√≤ng "${rid}" ƒë√£ t·ªìn t·∫°i${ack.locked ? " (üîí)" : ""}. Nh·∫•n 'V√†o ph√≤ng' ƒë·ªÉ v√†o.`
                        : `Ph√≤ng "${rid}" ch∆∞a t·ªìn t·∫°i. B·∫°n c√≥ th·ªÉ T·∫°o m·ªõi${$("roomPass").value ? " (s·∫Ω üîí)" : ""}.`;
                });
            });

            // Join ph√≤ng (n·∫øu c√≥ m·∫≠t kh·∫©u th√¨ nh·∫≠p ·ªü √¥ roomPass)
            $("btnJoin").addEventListener("click", () => {
                const rid = $("roomId").value.trim();
                const pwd = $("roomPass").value;
                if (!rid) { $("gState").textContent = "Nh·∫≠p Room ID"; return; }

                socket.emit("room:join", { roomId: rid, password: pwd }, (ack) => {
                    if (!ack?.ok) {
                        const m =
                            ack?.error === "ALREADY_IN_ROOM" ? "B·∫°n ƒëang ·ªü ph√≤ng n√†y r·ªìi." :
                                ack?.error === "WRONG_PASSWORD" ? "Sai m·∫≠t kh·∫©u." :
                                    ack?.error === "ROOM_NOT_FOUND" ? "Ph√≤ng kh√¥ng t·ªìn t·∫°i." :
                                        ack?.error || "V√†o ph√≤ng l·ªói";
                        $("gState").textContent = m;
                        return;
                    }

                    currentRoom = ack.roomId;
                    $("curRoom").textContent = currentRoom;
                    $("gState").textContent = `ƒê√£ v√†o: ${currentRoom} | Members: ${ack.members.join(", ")}${ack.locked ? " | üîí" : ""}`;
                    $("composer").style.display = "";
                    thread.innerHTML = "";
                    render({ side: "you", name: "BOT ü§ñ", text: `B·∫°n ƒë√£ v√†o ph√≤ng`, at: Date.now() });
                });
            });

            // Invite v√†o ph√≤ng hi·ªán t·∫°i (ng∆∞·ªùi ƒë∆∞·ª£c m·ªùi KH√îNG c·∫ßn m·∫≠t kh·∫©u)
            $("btnInvite").addEventListener("click", () => {
                if (!currentRoom) { $("gState").textContent = "B·∫°n ch∆∞a ·ªü ph√≤ng n√†o"; return; }
                const pid = $("invitePeer").value.trim();
                if (!pid) { $("gState").textContent = "Nh·∫≠p ID ƒë·ªÉ m·ªùi"; return; }
                socket.emit("room:invite", { roomId: currentRoom, peerId: pid }, (ack) => {
                    $("gState").textContent = ack?.ok
                        ? `ƒê√£ g·ª≠i l·ªùi m·ªùi t·ªõi ${pid}`
                        : (
                            ack?.error === "PEER_ALREADY_IN_ROOM" ? `User ${pid} ƒë√£ ·ªü trong ph√≤ng.` :
                                ack?.error === "ROOM_NOT_FOUND" ? "Ph√≤ng kh√¥ng t·ªìn t·∫°i." :
                                    ack?.error || "M·ªùi l·ªói"
                        );
                });

            });

            // G·ª≠i tin v√†o ph√≤ng
            $("composer").addEventListener("submit", (e) => {
                e.preventDefault();
                const text = msgInput.value.trim();
                if (!text || !currentRoom) return;
                socket.emit("room:send", { roomId: currentRoom, text }, (ack) => {
                    if (!ack?.ok) render({ side: "you", name: "BOT ü§ñ", text: `G·ª≠i l·ªói: ${ack?.error || "Unknown"}`, at: Date.now() });
                });
                msgInput.value = ""; msgInput.focus();
            });
        });
    </script>

</body>

</html>